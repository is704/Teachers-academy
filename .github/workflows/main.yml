name: Deploy Teacher's Academy

on:
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  push:
    branches: [ "main" ]
  
  # ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ pull request
  pull_request:
    branches: [ "main" ]
  
  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† ØµÙØ­Ø© Actions
  workflow_dispatch:
  
  # ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹
  schedule:
    - cron: '0 0 * * 0'  # ÙƒÙ„ ÙŠÙˆÙ… Ø£Ø­Ø¯ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„

# Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
env:
  NODE_VERSION: '18'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
  lint:
    name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† HTML
        run: |
          echo "ðŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª..."
          echo ""
          echo "ðŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:"
          required_files=("index.html" "style.css" "app.js" "README.md")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file Ù…ÙˆØ¬ÙˆØ¯"
            else
              echo "âŒ $file Ù…ÙÙ‚ÙˆØ¯"
            fi
          done
          
          echo ""
          echo "ðŸ“‚ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:"
          required_dirs=("pages" "ai-assistant" "community" "resources")
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… $dir Ù…ÙˆØ¬ÙˆØ¯"
              echo "   Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ $dir:"
              ls "$dir" | head -5 | sed 's/^/     /'
            else
              echo "âŒ $dir Ù…ÙÙ‚ÙˆØ¯"
            fi
          done
      
      - name: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        run: |
          echo "ðŸ”— ÙØ­Øµ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©..."
          if [ -f "index.html" ]; then
            echo "âœ… index.html Ù…ÙˆØ¬ÙˆØ¯"
            echo "   Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª CSS ÙˆJS..."
            css_count=$(grep -c 'style.css' index.html || true)
            js_count=$(grep -c '.js' index.html || true)
            echo "   Ø¹Ø¯Ø¯ Ù…Ù„ÙØ§Øª CSS: $css_count"
            echo "   Ø¹Ø¯Ø¯ Ù…Ù„ÙØ§Øª JavaScript: $js_count"
          fi
      
      - name: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡
        run: |
          echo "âš¡ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø¬Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹..."
          total_size=$(du -sh . | cut -f1)
          echo "   Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: $total_size"
          
          echo ""
          echo "ðŸ“Š Ø­Ø¬Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©:"
          find . -type f -size +100k -name "*.html" -o -name "*.js" -o -name "*.css" | \
          xargs ls -lh | awk '{print $5, $9}' | head -10

  # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  build:
    name: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    needs: lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
        uses: actions/checkout@v4
      
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª
        run: |
          # ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª
          npm install -g html-minifier-terser clean-css-cli uglify-js
      
      - name: ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        run: |
          echo "ðŸ› ï¸ ØªØ­Ø³ÙŠÙ† Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹..."
          
          # ØªØ­Ø³ÙŠÙ† CSS Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒØ¨ÙŠØ±Ø§Ù‹
          if [ -f "style.css" ]; then
            css_size=$(stat -c%s "style.css")
            if [ $css_size -gt 50000 ]; then
              echo "   ØªØ­Ø³ÙŠÙ† style.css..."
              npx clean-css-cli -o style.min.css style.css
              mv style.min.css style.css
            fi
          fi
          
          # ØªØ­Ø³ÙŠÙ† JS Ø¥Ø°Ø§ ÙƒØ§Ù† ÙƒØ¨ÙŠØ±Ø§Ù‹
          if [ -f "app.js" ]; then
            js_size=$(stat -c%s "app.js")
            if [ $js_size -gt 50000 ]; then
              echo "   ØªØ­Ø³ÙŠÙ† app.js..."
              npx uglify-js app.js -o app.min.js -c -m
              mv app.min.js app.js
            fi
          fi
      
      - name: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù service worker
        run: |
          echo "ðŸ‘· Ø¥Ù†Ø´Ø§Ø¡ service worker..."
          cat > sw.js << 'EOF'
          const CACHE_NAME = 'teachers-academy-v2';
          const urlsToCache = [
            '/',
            '/index.html',
            '/style.css',
            '/app.js',
            '/manifest.json',
            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css'
          ];
          
          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => cache.addAll(urlsToCache))
            );
          });
          
          self.addEventListener('fetch', event => {
            event.respondWith(
              caches.match(event.request)
                .then(response => response || fetch(event.request))
            );
          });
          
          self.addEventListener('activate', event => {
            event.waitUntil(
              caches.keys().then(cacheNames => {
                return Promise.all(
                  cacheNames.map(cache => {
                    if (cache !== CACHE_NAME) {
                      return caches.delete(cache);
                    }
                  })
                );
              })
            );
          });
          EOF
      
      - name: Ø¥Ù†Ø´Ø§Ø¡ manifest.json
        run: |
          echo "ðŸ“± Ø¥Ù†Ø´Ø§Ø¡ manifest.json..."
          cat > manifest.json << 'EOF'
          {
            "name": "Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©",
            "short_name": "Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©",
            "description": "Ù…Ù†ØµØ© ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ³",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#4f46e5",
            "theme_color": "#4f46e5",
            "orientation": "portrait",
            "icons": [
              {
                "src": "icon-192.png",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "icon-512.png",
                "sizes": "512x512",
                "type": "image/png"
              }
            ],
            "lang": "ar",
            "dir": "rtl"
          }
          EOF
      
      - name: Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª
        uses: actions/upload-artifact@v4
        with:
          name: built-website
          path: |
            .
            !.git
            !node_modules

  # Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ GitHub Pages
  deploy:
    name: Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
        uses: actions/download-artifact@v4
        with:
          name: built-website
      
      - name: Ø¥Ø¹Ø¯Ø§Ø¯ Pages
        uses: actions/configure-pages@v4
      
      - name: Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ù†Ø´Ø±
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Ø§Ù„Ù†Ø´Ø±
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø±
        run: |
          echo "ðŸš€ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ðŸ“Š Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ• ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø±: $(date)"
          
          # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
          echo ""
          echo "ðŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹:"
          echo "ðŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: $(find . -type f | wc -l)"
          echo "ðŸ’¾ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: $(du -sh . | cut -f1)"

  # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±
  test:
    name: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
      - name: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        run: |
          echo "ðŸŒ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø´ÙˆØ±..."
          URL="${{ steps.deployment.outputs.page_url }}"
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¬Ø§Ù‡Ø²Ø§Ù‹
          sleep 30
          
          # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
          if curl -s -o /dev/null -w "%{http_code}" "$URL" | grep -q "200"; then
            echo "âœ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (HTTP 200)"
          else
            echo "âŒ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹"
            exit 1
          fi
      
      - name: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        run: |
          echo "ðŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©..."
          echo ""
          echo "1. âœ… GitHub Pages Ù…ÙØ¹Ù„"
          echo "2. âœ… Ø§Ù„Ù…Ù„ÙØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©"
          echo "3. âœ… Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØµØ§Ù„Ø­Ø©"
          echo ""
          echo "ðŸŽ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª!"
